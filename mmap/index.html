<!DOCTYPE html>

<html>

<head>
	<meta charset="utf-8" />
	<title>Marauder's Map</title>

	<link rel="stylesheet" href="style.css" type="text/css" />

	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"> </script>

	<script>

		var request = new XMLHttpRequest();

		var myLat = 0;
		var myLng = 0;
		var myLocation = new google.maps.LatLng(myLat, myLng);
		
		var map_settings = {
								zoom: 13,
								center: myLocation,
								mapTypeId: google.maps.MapTypeId.ROADMAP
						   };

		function init()
		{
			map = new google.maps.Map(document.getElementById("mmap"), map_settings);

			getMyLocation();
		}
		
		function getMyLocation()
		{
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
					myLat = position.coords.latitude;
					myLng = position.coords.longitude;
					postMyLocation();
				});
			} else {
				alert("Geolocation is not supported by your browser!");
			}
		}

		function postMyLocation()
		{
			username = "JefflynMcKelvey";
			database_url = "https://secret-about-box.herokuapp.com/sendLocation";

			request.open("POST", database_url, true);
			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			request.send("login=" + username + "&lat=" + myLat + "&lng=" + myLng);

			request.onreadystatechange = function() {
    			if(request.readyState == 4 && request.status == 200) {
        			drawMap();
    			}
			}
		}

		function drawMap()
		{	
			myLocation = new google.maps.LatLng(myLat, myLng);
			infowindow = new google.maps.InfoWindow();

			map.panTo(myLocation);

			location_list = JSON.parse(request.responseText);

			for (var i = 0; i < location_list.length; i++) {

				person_username = location_list[i]['login'];
				person_location = new google.maps.LatLng(location_list[i]['lat'], location_list[i]['lng']);
				person_distance = '0 miles';

				addMarkertoMap();
			}	
		}

		function addMarkertoMap()
		{
			var marker = new google.maps.Marker({
				position: person_location,
				map: map,
				title: person_username
			});

			google.maps.event.addListener(marker, 'click', function() {

				var contentString = '<h1>' + marker.title + '</h1>' + '<h2> Distance: ' + marker.position + '</h2>';
				infowindow.setContent(contentString);
    			infowindow.open(map, marker);

  			});
		}

	</script>

</head>

<body onload="init()">
	<div id="mmap"> </div>
</body>

</html>